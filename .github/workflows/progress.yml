name: Update Progress

on:
  push:
    branches: [main]
    paths:
      - 'config/decompiled.txt'

permissions:
  contents: write

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update README progress
        run: |
          python3 -c "
          import re, urllib.parse

          TOTAL = 1279344
          matched = hw = mc = hc = 0
          with open('config/decompiled.txt') as f:
              for line in f:
                  line = line.strip()
                  if not line or line.startswith('#'): continue
                  m = re.match(r'(\w+)\s*=\s*(0x[0-9A-Fa-f]+),\s*(0x[0-9A-Fa-f]+);', line)
                  if m:
                      size = int(m.group(3), 16)
                      if 'HARDWARE' in line:
                          hw += size; hc += 1
                      else:
                          matched += size; mc += 1

          total = matched + hw
          pct = (total / TOTAL) * 100
          pct_encoded = urllib.parse.quote(f'{pct:.3f}%')

          table = f'''<!--progress-start-->
          | Version | Target | Bytes | Progress |
          |---------|--------|-------|----------|
          | NTSC-U  | \`SLUS_204.69\` | {total:,} / 1,279,344 | ![Progress](https://img.shields.io/badge/{pct_encoded}-blue?style=flat) |
          | NTSC-J  | \`SLPS_290.02\` | — | Planned |
          | Reloaded | \`SLPS_290.05\` | — | Planned |
          <!--progress-end-->'''
          table = '\n'.join(line.lstrip() for line in table.split('\n'))

          with open('README.md') as f:
              readme = f.read()

          readme = re.sub(
              r'<!--progress-start-->.*?<!--progress-end-->',
              table, readme, flags=re.DOTALL
          )

          with open('README.md', 'w') as f:
              f.write(readme)
          "

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git diff --quiet README.md || (git add README.md && git commit -m "Update decompilation progress" && git push)
