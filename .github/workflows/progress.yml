name: Update Progress

on:
  push:
    branches: [main]
    paths:
      - 'config/decompiled.txt'

permissions:
  contents: write

jobs:
  update-progress:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Calculate progress
        id: progress
        run: |
          python3 -c "
          import re
          TOTAL = 1279344
          matched = hw = mc = hc = 0
          with open('config/decompiled.txt') as f:
              for line in f:
                  line = line.strip()
                  if not line or line.startswith('#'): continue
                  m = re.match(r'(\w+)\s*=\s*(0x[0-9A-Fa-f]+),\s*(0x[0-9A-Fa-f]+);', line)
                  if m:
                      size = int(m.group(3), 16)
                      if 'HARDWARE' in line:
                          hw += size; hc += 1
                      else:
                          matched += size; mc += 1
          total = matched + hw
          pct = (total / TOTAL) * 100
          print(f'PROGRESS={pct:.3f}')
          print(f'MATCHED={mc}')
          print(f'MATCHED_BYTES={matched}')
          print(f'HARDWARE={hc}')
          print(f'HARDWARE_BYTES={hw}')
          print(f'TOTAL={mc + hc}')
          print(f'TOTAL_BYTES={total}')
          " >> "$GITHUB_OUTPUT"

      - name: Update README
        run: |
          python3 -c "
          import re, os

          # Read values from step output
          env = dict(line.split('=', 1) for line in open(os.environ['GITHUB_OUTPUT']).read().strip().split('\n') if '=' in line)

          with open('README.md') as f:
              readme = f.read()

          table = '''### Decompilation Progress

          | Category | Functions | Bytes | %% of .text |
          |----------|-----------|-------|------------|
          | Matched  | {MATCHED:<9} | {MATCHED_BYTES:<5} | {matched_pct}     |
          | Hardware | {HARDWARE:<9} | {HARDWARE_BYTES:<5} | {hw_pct}     |
          | **Total**| **{TOTAL}**     | **{TOTAL_BYTES}**| **{PROGRESS}%%** |

          *Auto-updated on each push. Run \`python3 tools/progress.py\` locally for current stats.*'''.format(
              **env,
              matched_pct=f\"{(int(env['MATCHED_BYTES'])/1279344)*100:.3f}%\",
              hw_pct=f\"{(int(env['HARDWARE_BYTES'])/1279344)*100:.3f}%\"
          )
          # Remove extra indentation
          table = '\n'.join(line.lstrip() for line in table.split('\n'))

          # Replace between progress markers
          readme = re.sub(
              r'### Decompilation Progress.*?\*Auto-updated.*?\*',
              table,
              readme,
              flags=re.DOTALL
          )

          with open('README.md', 'w') as f:
              f.write(readme)
          "

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git diff --quiet README.md || (git add README.md && git commit -m "Update decompilation progress" && git push)
